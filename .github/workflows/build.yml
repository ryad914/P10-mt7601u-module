name: build-mt7601u

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git wget bc \
          flex bison libssl-dev \
          libncurses5-dev libncursesw5-dev \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

    - name: Prepare kernel folder
      run: mkdir -p kernel

    - name: Download Huawei P10 Kernel Source
      run: |
        cd kernel
        wget "https://download-c1.huawei.com/download/downloadCenter?downloadId=B87082E9CE997D8645041978C5217002&version=F15A20CE67D1FE8501BD721465A67ACC&siteCode=worldwide" -O kernel.tar.gz
        tar -xvzf kernel.tar.gz
        rm kernel.tar.gz

    - name: Create minimal .config
      run: |
        cd kernel/Code_Opensource/kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make defconfig
        echo "CONFIG_MT7601U=m" >> .config
        make olddefconfig
        make prepare

    - name: Build mt7601u module
      run: |
        cd kernel/Code_Opensource/kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make M=drivers/net/wireless/mediatek/mt7601u modules

    - name: List compiled modules
      run: |
        find kernel/Code_Opensource/kernel -name "*.ko" || echo "No modules found"

    - name: Upload mt7601u.ko
      uses: actions/upload-artifact@v4
      with:
        name: mt7601u-ko
        path: kernel/Code_Opensource/kernel/drivers/net/wireless/mediatek/mt7601u/mt7601u.ko
